<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Welfare App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
   :root {
    --primary-color: #3498db;
    --secondary-color: #2c3e50;
    --accent-color: #e74c3c;
    --light-color: #ecf0f1;
    --dark-color: #2c3e50;
    --education-color: #9b59b6; /* New color for education card */
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f5f5f5;
}

/* Sidebar */
.sidebar {
    background-color: var(--secondary-color);
    color: white;
    height: 100vh;
    position: fixed;
    transition: all 0.3s;
}

.sidebar .nav-link {
    color: rgba(255, 255, 255, 0.8);
    border-radius: 5px;
    margin-bottom: 5px;
    transition: all 0.3s;
}

.sidebar .nav-link:hover, 
.sidebar .nav-link.active {
    background-color: var(--primary-color);
    color: white;
}

.sidebar .nav-link i {
    margin-right: 10px;
}

.main-content {
    margin-left: 250px;
    padding: 20px;
    transition: all 0.3s;
}

/* Mobile Menu */
.mobile-menu-container {
    display: none;
    overflow-x: auto;
    white-space: nowrap;
    padding: 10px 0;
    background-color: var(--secondary-color);
    position: sticky;
    top: 0;
    z-index: 1000;
}

.mobile-menu-scroll {
    display: inline-flex;
    gap: 5px;
    padding: 0 10px;
}

.mobile-menu-link {
    display: inline-block;
    color: rgba(255, 255, 255, 0.8);
    padding: 8px 12px;
    border-radius: 5px;
    text-decoration: none;
    transition: all 0.3s;
}

.mobile-menu-link:hover, 
.mobile-menu-link.active {
    background-color: var(--primary-color);
    color: white;
}

/* Dashboard Cards */
.dashboard-card {
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s;
    margin-bottom: 20px;
    border: none;
}

.dashboard-card:hover {
    transform: translateY(-5px);
}

.card-icon {
    font-size: 2rem;
    opacity: 0.7;
}

/* Specific card colors */
.dashboard-card.bg-primary { background-color: var(--primary-color) !important; }
.dashboard-card.bg-success { background-color: #27ae60 !important; }
.dashboard-card.bg-info { background-color: #2980b9 !important; }
.dashboard-card.bg-warning { background-color: #f39c12 !important; }
.dashboard-card.bg-danger { background-color: var(--education-color) !important; } /* Education card */

/* Tables */
.table-responsive {
    overflow-x: auto;
    margin-bottom: 20px;
}

.table {
    border-collapse: collapse;
    width: 100%;
    margin-bottom: 1rem;
    background-color: transparent;
}

.table th {
    background-color: var(--light-color);
    color: var(--dark-color);
    font-weight: 600;
}

.table td, .table th {
    padding: 12px 15px;
    vertical-align: middle;
    border-top: 1px solid #dee2e6;
}

/* Table totals row */
.table-total {
    font-weight: bold;
    background-color: rgba(52, 152, 219, 0.1) !important;
    color: var(--dark-color);
}

.table-total th {
    border-top: 2px solid var(--primary-color);
}

/* Action buttons */
.action-buttons .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    margin: 2px;
}

.print-button {
    background-color: #6c757d;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
}

/* Search input */
.dataTables_filter input {
    pointer-events: auto !important;
    cursor: text !important;
    width: 200px !important;
    padding: 8px !important;
    border: 1px solid #ddd !important;
    border-radius: 4px !important;
    transition: all 0.3s;
}

.dataTables_filter input:focus {
    outline: none !important;
    border-color: var(--primary-color) !important;
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2) !important;
}

/* Login Styles */
.login-container {
    max-width: 400px;
    margin: 100px auto;
}

.login-card {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Admin Controls */
.admin-only { 
    display: none; 
}

/* User/Admin Switch */
.access-switch {
    position: fixed;
    top: 10px;
    right: 10px;
    z-index: 1000;
}

/* Responsive */
@media (max-width: 768px) {
    .sidebar {
        display: none;
    }
    
    .mobile-menu-container {
        display: block;
    }
    
    .main-content {
        margin-left: 0;
    }
    
    .access-switch {
        position: static;
        margin-bottom: 20px;
        text-align: center;
    }
    
    .dashboard-card {
        margin-bottom: 15px;
    }
}

/* Print Styles */
@media print {
    .no-print {
        display: none !important;
    }
    
    body {
        padding: 0;
        margin: 0;
        font-size: 12pt;
        background: white;
        color: black;
    }
    
    .main-content {
        margin-left: 0;
        padding: 0;
    }
    
    .table {
        page-break-inside: avoid;
    }
    
    .table th {
        background-color: #f8f9fa !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .table-total {
        background-color: rgba(52, 152, 219, 0.1) !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .table td, .table th {
        border-color: #ddd !important;
    }
    
    .card {
        border: none !important;
        box-shadow: none !important;
    }
    
    .dashboard-card {
        break-inside: avoid;
        margin-bottom: 15pt;
    }
    
    .dashboard-card .card-body {
        padding: 10pt !important;
    }
    
    .dashboard-card .card-icon {
        font-size: 1.5rem;
    }
    
    .dashboard-card h6 {
        font-size: 10pt;
        margin-bottom: 5pt;
    }
    
    .dashboard-card h2 {
        font-size: 18pt;
        margin-bottom: 0;
    }
}

/* Dashboard grid layout */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

@media (max-width: 576px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
}
    </style>
</head>
<body>
    <!-- Access Switch -->
    <div class="access-switch">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary active" id="userAccessBtn">User Access</button>
            <button type="button" class="btn btn-outline-success" id="adminAccessBtn">Admin Access</button>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- Mobile Menu -->
            <div class="mobile-menu-container">
                <div class="mobile-menu-scroll">
                    <a href="#" class="mobile-menu-link active" data-section="dashboard">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                    <a href="#" class="mobile-menu-link" data-section="members">
                        <i class="fas fa-users"></i> Members
                    </a>
                    <a href="#" class="mobile-menu-link" data-section="savings">
                        <i class="fas fa-piggy-bank"></i> Savings
                    </a>
                    <a href="#" class="mobile-menu-link" data-section="condolences">
                        <i class="fas fa-hands-helping"></i> Condolences
                    </a>
                    <a href="#" class="mobile-menu-link" data-section="health">
                        <i class="fas fa-heartbeat"></i> Health
                    </a>
                    <a href="#" class="mobile-menu-link" data-section="education">
                        <i class="fas fa-graduation-cap"></i> Education
                    </a>
                </div>
            </div>

            <!-- Desktop Sidebar -->
            <div class="col-md-3 col-lg-2 d-md-block sidebar collapse bg-dark">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h4 class="text-white">Community Welfare</h4>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-section="dashboard">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="members">
                                <i class="fas fa-users"></i> Members
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="savings">
                                <i class="fas fa-piggy-bank"></i> Savings
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="condolences">
                                <i class="fas fa-hands-helping"></i> Condolences
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="health">
                                <i class="fas fa-heartbeat"></i> Health
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="education">
                                <i class="fas fa-graduation-cap"></i> Education
                            </a>
                        </li>
                    </ul>
                </div>
            </div>


    <div class="container-fluid">
        <div class="row">
            <!-- Main Content -->
            <main class="col-md-12 px-md-4 main-content">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="content-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Dashboard</h1>
                    </div>
                    
                    <div class="row">
                        <!-- Members Card -->
                        <div class="col-md-3">
                            <div class="card text-white bg-primary dashboard-card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="card-title">Total Members</h6>
                                            <h2 id="total-members" class="card-text">0</h2>
                                        </div>
                                        <i class="fas fa-users card-icon"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Savings Card -->
                        <div class="col-md-3">
                            <div class="card text-white bg-success dashboard-card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="card-title">Total Savings</h6>
                                            <h2 id="total-savings" class="card-text">KES 0</h2>
                                        </div>
                                        <i class="fas fa-piggy-bank card-icon"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Condolences Card -->
                        <div class="col-md-3">
                            <div class="card text-white bg-info dashboard-card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="card-title">Total Condolences</h6>
                                            <h2 id="total-condolences" class="card-text">KES 0</h2>
                                        </div>
                                        <i class="fas fa-hands-helping card-icon"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Health Card -->
                        <div class="col-md-3">
                            <div class="card text-white bg-warning dashboard-card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="card-title">Total Health</h6>
                                            <h2 id="total-health" class="card-text">KES 0</h2>
                                        </div>
                                        <i class="fas fa-heartbeat card-icon"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Education Card (New) -->
                        <div class="col-md-3 mt-3">
                            <div class="card text-white bg-danger dashboard-card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="card-title">Total Education</h6>
                                            <h2 id="total-education" class="card-text">KES 0</h2>
                                        </div>
                                        <i class="fas fa-graduation-cap card-icon"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Beneficiaries Table -->
                    <div class="card mt-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>Beneficiaries Summary</h5>
                            <button class="btn btn-secondary print-button no-print" onclick="printTable('beneficiaries-table')">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="beneficiaries-table" class="table table-striped table-bordered" style="width:100%">
                                    <thead>
                                        <tr>
                                            <th>Beneficiary Name</th>
                                            <th>Total Amount (KES)</th>
                                            <th>Contributors</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                    <tfoot>
                                        <tr class="table-total">
                                            <th>Total</th>
                                            <th id="beneficiaries-total">KES 0</th>
                                            <th id="beneficiaries-count">0</th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                
                <!-- Members Section -->
                <div id="members-section" class="content-section" style="display:none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Members</h1>
                        <button class="btn btn-primary admin-only" data-bs-toggle="modal" data-bs-target="#addMemberModal">
                            <i class="fas fa-plus"></i> Add Member
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>Members List</h5>
                            <button class="print-button" onclick="printTable('members-table')">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="members-table" class="table table-striped table-bordered" style="width:100%">
                                    <thead>
                                        <tr>
                                            <th>Member ID</th>
                                            <th>Name</th>
                                            <th>Contact</th>
                                            <th>Sub Location</th>
                                            <th>Clan</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Savings Section -->
                <div id="savings-section" class="content-section" style="display:none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Savings</h1>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSavingsModal">
                            <i class="fas fa-plus"></i> Add Savings
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>Savings Contributions</h5>
                            <button class="print-button" onclick="printTable('savings-table')">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="savings-table" class="table table-striped table-bordered" style="width:100%">
                                    <thead>
                                        <tr>
                                            <th>Member ID</th>
                                            <th>Name</th>
                                            <th>Amount (KES)</th>
                                            <th>Beneficiary</th>
                                            <th>Date</th>
                                            <th>Time</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Condolences Section -->
                <div id="condolences-section" class="content-section" style="display:none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Condolences</h1>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCondolenceModal">
                            <i class="fas fa-plus"></i> Add Condolence
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>Condolences Contributions</h5>
                            <button class="print-button" onclick="printTable('condolences-table')">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="condolences-table" class="table table-striped table-bordered" style="width:100%">
                                    <thead>
                                        <tr>
                                            <th>Member ID</th>
                                            <th>Name</th>
                                            <th>Amount (KES)</th>
                                            <th>Beneficiary</th>
                                            <th>Date</th>
                                            <th>Time</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Health Section -->
                <div id="health-section" class="content-section" style="display:none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Health</h1>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addHealthModal">
                            <i class="fas fa-plus"></i> Add Health Contribution
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>Health Contributions</h5>
                            <button class="print-button" onclick="printTable('health-table')">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="health-table" class="table table-striped table-bordered" style="width:100%">
                                    <thead>
                                        <tr>
                                            <th>Member ID</th>
                                            <th>Name</th>
                                            <th>Amount (KES)</th>
                                            <th>Beneficiary</th>
                                            <th>Date</th>
                                            <th>Time</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Education Section -->
                <div id="education-section" class="content-section" style="display:none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Education</h1>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEducationModal">
                            <i class="fas fa-plus"></i> Add Education Contribution
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>Education Contributions</h5>
                            <button class="print-button" onclick="printTable('education-table')">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="education-table" class="table table-striped table-bordered" style="width:100%">
                                    <thead>
                                        <tr>
                                            <th>Member ID</th>
                                            <th>Name</th>
                                            <th>Amount (KES)</th>
                                            <th>Beneficiary</th>
                                            <th>Date</th>
                                            <th>Time</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div class="modal fade" id="adminLoginModal" tabindex="-1" aria-labelledby="adminLoginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adminLoginModalLabel">Admin Login</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="adminLoginForm">
                        <div class="mb-3">
                            <label for="adminUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="adminUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="adminPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="adminPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="adminLoginBtn">Login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- All Modals -->
    <!-- Member Modal -->
    <div class="modal fade" id="addMemberModal" tabindex="-1" aria-labelledby="addMemberModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addMemberModalLabel">Add New Member</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="memberForm">
                        <div class="mb-3">
                            <label for="memberName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="memberName" required>
                        </div>
                        <div class="mb-3">
                            <label for="memberContact" class="form-label">Contact</label>
                            <input type="text" class="form-control" id="memberContact" required>
                        </div>
                        <div class="mb-3">
                            <label for="memberSubLocation" class="form-label">Sub Location</label>
                            <input type="text" class="form-control" id="memberSubLocation" required>
                        </div>
                        <div class="mb-3">
                            <label for="memberClan" class="form-label">Clan</label>
                            <input type="text" class="form-control" id="memberClan" required>
                        </div>
                        <input type="hidden" id="memberId">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveMemberBtn">Save Member</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Savings Modal -->
    <div class="modal fade" id="addSavingsModal" tabindex="-1" aria-labelledby="addSavingsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSavingsModalLabel">Add Savings Contribution</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="savingsForm">
                        <div class="mb-3">
                            <label for="savingsMember" class="form-label">Member</label>
                            <select class="form-select" id="savingsMember" required>
                                <option value="">Select Member</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="savingsAmount" class="form-label">Amount (KES)</label>
                            <input type="number" class="form-control" id="savingsAmount" required>
                        </div>
                        <div class="mb-3">
                            <label for="savingsBeneficiary" class="form-label">Beneficiary</label>
                            <select class="form-select" id="savingsBeneficiary" required>
                                <option value="">Select Beneficiary</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="savingsDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="savingsDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="savingsTime" class="form-label">Time</label>
                            <input type="time" class="form-control" id="savingsTime" required>
                        </div>
                        <input type="hidden" id="savingsId">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveSavingsBtn">Save Contribution</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Condolence Modal -->
    <div class="modal fade" id="addCondolenceModal" tabindex="-1" aria-labelledby="addCondolenceModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCondolenceModalLabel">Add Condolence Contribution</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="condolenceForm">
                        <div class="mb-3">
                            <label for="condolenceMember" class="form-label">Member</label>
                            <select class="form-select" id="condolenceMember" required>
                                <option value="">Select Member</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="condolenceAmount" class="form-label">Amount (KES)</label>
                            <input type="number" class="form-control" id="condolenceAmount" required>
                        </div>
                        <div class="mb-3">
                            <label for="condolenceBeneficiary" class="form-label">Beneficiary</label>
                            <select class="form-select" id="condolenceBeneficiary" required>
                                <option value="">Select Beneficiary</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="condolenceDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="condolenceDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="condolenceTime" class="form-label">Time</label>
                            <input type="time" class="form-control" id="condolenceTime" required>
                        </div>
                        <input type="hidden" id="condolenceId">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveCondolenceBtn">Save Contribution</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Health Modal -->
    <div class="modal fade" id="addHealthModal" tabindex="-1" aria-labelledby="addHealthModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addHealthModalLabel">Add Health Contribution</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="healthForm">
                        <div class="mb-3">
                            <label for="healthMember" class="form-label">Member</label>
                            <select class="form-select" id="healthMember" required>
                                <option value="">Select Member</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="healthAmount" class="form-label">Amount (KES)</label>
                            <input type="number" class="form-control" id="healthAmount" required>
                        </div>
                        <div class="mb-3">
                            <label for="healthBeneficiary" class="form-label">Beneficiary</label>
                            <select class="form-select" id="healthBeneficiary" required>
                                <option value="">Select Beneficiary</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="healthDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="healthDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="healthTime" class="form-label">Time</label>
                            <input type="time" class="form-control" id="healthTime" required>
                        </div>
                        <input type="hidden" id="healthId">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveHealthBtn">Save Contribution</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Education Modal -->
    <div class="modal fade" id="addEducationModal" tabindex="-1" aria-labelledby="addEducationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addEducationModalLabel">Add Education Contribution</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="educationForm">
                        <div class="mb-3">
                            <label for="educationMember" class="form-label">Member</label>
                            <select class="form-select" id="educationMember" required>
                                <option value="">Select Member</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="educationAmount" class="form-label">Amount (KES)</label>
                            <input type="number" class="form-control" id="educationAmount" required>
                        </div>
                        <div class="mb-3">
                            <label for="educationBeneficiary" class="form-label">Beneficiary</label>
                            <select class="form-select" id="educationBeneficiary" required>
                                <option value="">Select Beneficiary</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="educationDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="educationDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="educationTime" class="form-label">Time</label>
                            <input type="time" class="form-control" id="educationTime" required>
                        </div>
                        <input type="hidden" id="educationId">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveEducationBtn">Save Contribution</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel">Confirm Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmationMessage">
                    Are you sure you want to perform this action?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmActionBtn">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Main Application Script -->
    <script>
        // Global variables
        let currentUserRole = 'user'; // 'user' or 'admin'
        let membersData = [];
        let savingsData = [];
        let condolencesData = [];
        let healthData = [];
        let educationData = [];
        let scriptUrl = 'https://script.google.com/macros/s/AKfycbw6p20Cbrr61UtGeiEqyOqlC9PTjdOrUovvNsPB2i_tVXOBvR1XWeaxaZXJ-BaY2Bo8/exec';

        // Initialize the application
        $(document).ready(function() {
            initializeApp();
        });

        function initializeApp() {
            setupAccessControls();
            setupNavigation();
            setupFormHandlers();
            initializeDataTables();
            setCurrentDateTime();
            loadAllData();
        }

        function setupAccessControls() {
            // Set default to user access
            switchToUserAccess();
            
            // User access button
            $('#userAccessBtn').click(function() {
                switchToUserAccess();
                $(this).addClass('active');
                $('#adminAccessBtn').removeClass('active');
            });
            
            // Admin access button
            $('#adminAccessBtn').click(function() {
                $('#adminLoginModal').modal('show');
                $(this).addClass('active');
                $('#userAccessBtn').removeClass('active');
            });
            
            // Admin login handler
            $('#adminLoginBtn').click(function() {
                const username = $('#adminUsername').val();
                const password = $('#adminPassword').val();
                
                if (username === 'admin' && password === 'admin001') {
                    switchToAdminAccess();
                    $('#adminLoginModal').modal('hide');
                    showSuccess('Admin access granted');
                } else {
                    showError('Invalid admin credentials');
                }
            });
        }

        function switchToUserAccess() {
            currentUserRole = 'user';
            $('.admin-only').hide();
            loadAllData();
        }

        function switchToAdminAccess() {
            currentUserRole = 'admin';
            $('.admin-only').show();
            loadAllData();
        }

        function loadAllData() {
            // Clear all tables first
            $('.table').each(function() {
                const tableId = $(this).attr('id');
                if ($.fn.DataTable.isDataTable('#' + tableId)) {
                    $('#' + tableId).DataTable().clear().destroy();
                }
            });
            
            // Then load data
            loadMembers();
            loadSavings();
            loadCondolences();
            loadHealth();
            loadEducation();
        }

        function generateMemberId() {
            if (membersData.length === 0) return 'MEM-001';
            
            const lastId = membersData.reduce((max, member) => {
                const num = parseInt(member.id.split('-')[1]) || 0;
                return num > max ? num : max;
            }, 0);
            
            return `MEM-${String(lastId + 1).padStart(3, '0')}`;
        }

        // Data Loading Functions
        function loadMembers() {
            showLoading('members-section');
            $.ajax({
                url: scriptUrl,
                method: 'GET',
                dataType: 'json',
                data: { action: 'getMembers' },
                success: function(data) {
                    membersData = Array.isArray(data) ? data : [];
                    populateMembersTable(membersData);
                    populateMemberDropdowns(membersData);
                    updateDashboardStats();
                    hideLoading('members-section');
                },
                error: function(error) {
                    console.error('Error loading members:', error);
                    const table = $('#members-table').DataTable();
                    table.clear();
                    table.row.add(['', '', '', '', '', 'Failed to load data']).draw();
                    hideLoading('members-section');
                }
            });
        }

        function loadSavings() {
            showLoading('savings-section');
            $.ajax({
                url: scriptUrl,
                method: 'GET',
                dataType: 'json',
                data: { action: 'getSavings' },
                success: function(data) {
                    savingsData = Array.isArray(data) ? data : [];
                    populateSavingsTable(savingsData);
                    updateDashboardStats();
                    hideLoading('savings-section');
                },
                error: function(error) {
                    console.error('Error loading savings:', error);
                    const table = $('#savings-table').DataTable();
                    table.clear();
                    table.row.add(['', '', '', '', '', '', '', 'Failed to load data']).draw();
                    hideLoading('savings-section');
                }
            });
        }

        function loadCondolences() {
            showLoading('condolences-section');
            $.ajax({
                url: scriptUrl,
                method: 'GET',
                dataType: 'json',
                data: { action: 'getCondolences' },
                success: function(data) {
                    condolencesData = Array.isArray(data) ? data : [];
                    populateCondolencesTable(condolencesData);
                    updateDashboardStats();
                    hideLoading('condolences-section');
                },
                error: function(error) {
                    console.error('Error loading condolences:', error);
                    const table = $('#condolences-table').DataTable();
                    table.clear();
                    table.row.add(['', '', '', '', '', '', '', 'Failed to load data']).draw();
                    hideLoading('condolences-section');
                }
            });
        }

        function loadHealth() {
            showLoading('health-section');
            $.ajax({
                url: scriptUrl,
                method: 'GET',
                dataType: 'json',
                data: { action: 'getHealth' },
                success: function(data) {
                    healthData = Array.isArray(data) ? data : [];
                    populateHealthTable(healthData);
                    updateDashboardStats();
                    hideLoading('health-section');
                },
                error: function(error) {
                    console.error('Error loading health data:', error);
                    const table = $('#health-table').DataTable();
                    table.clear();
                    table.row.add(['', '', '', '', '', '', '', 'Failed to load data']).draw();
                    hideLoading('health-section');
                }
            });
        }

        function loadEducation() {
            showLoading('education-section');
            $.ajax({
                url: scriptUrl,
                method: 'GET',
                dataType: 'json',
                data: { action: 'getEducation' },
                success: function(data) {
                    educationData = Array.isArray(data) ? data : [];
                    populateEducationTable(educationData);
                    updateDashboardStats();
                    hideLoading('education-section');
                },
                error: function(error) {
                    console.error('Error loading education data:', error);
                    const table = $('#education-table').DataTable();
                    table.clear();
                    table.row.add(['', '', '', '', '', '', '', 'Failed to load data']).draw();
                    hideLoading('education-section');
                }
            });
        }

        // Table Population Functions
        function populateMembersTable(data) {
            const table = $('#members-table').DataTable();
            table.clear().draw();
            
            if (data.length === 0) {
                table.row.add(['', '', '', '', '', 'No members found']).draw();
                return;
            }
            
            data.forEach(member => {
                let actionButtons = `
                    <button class="btn btn-sm btn-primary edit-member" data-id="${member.id}">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                `;
                
                if (currentUserRole === 'admin') {
                    actionButtons += `
                        <button class="btn btn-sm btn-danger delete-member" data-id="${member.id}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                }
                
                table.row.add([
                    member.id || '',
                    member.name || '',
                    member.contact || '',
                    member.subLocation || '',
                    member.clan || '',
                    `<div class="action-buttons">${actionButtons}</div>`
                ]).draw(false);
            });
        }

        function populateSavingsTable(data) {
            const table = $('#savings-table').DataTable();
            table.clear().draw();
            
            if (data.length === 0) {
                table.row.add(['', '', '', '', '', '', '', 'No savings contributions found']).draw();
                return;
            }
            
            data.forEach(saving => {
                const member = membersData.find(m => m.id === saving.memberId);
                const beneficiary = membersData.find(m => m.id === saving.beneficiaryId);
                const statusBadge = saving.status === 'approved' ? 
                    '<span class="badge bg-success">Approved</span>' : 
                    '<span class="badge bg-warning text-dark">Pending</span>';
                
                let actionButtons = `
                    <button class="btn btn-sm btn-primary edit-saving" data-id="${saving.id}">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                `;
                
                if (currentUserRole === 'admin') {
                    if (saving.status !== 'approved') {
                        actionButtons += `
                            <button class="btn btn-sm btn-success approve-saving" data-id="${saving.id}">
                                <i class="fas fa-check"></i> Approve
                            </button>
                        `;
                    }
                    actionButtons += `
                        <button class="btn btn-sm btn-danger delete-saving" data-id="${saving.id}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                }
                
                table.row.add([
                    saving.memberId || '',
                    member ? member.name : 'Unknown',
                    'KES ' + parseFloat(saving.amount || 0).toLocaleString(),
                    beneficiary ? beneficiary.name : 'Unknown',
                    saving.date || '',
                    saving.time || '',
                    statusBadge,
                    `<div class="action-buttons">${actionButtons}</div>`
                ]).draw(false);
            });
        }

        function populateCondolencesTable(data) {
            const table = $('#condolences-table').DataTable();
            table.clear().draw();
            
            if (data.length === 0) {
                table.row.add(['', '', '', '', '', '', '', 'No condolences contributions found']).draw();
                return;
            }
            
            data.forEach(condolence => {
                const member = membersData.find(m => m.id === condolence.memberId);
                const beneficiary = membersData.find(m => m.id === condolence.beneficiaryId);
                const statusBadge = condolence.status === 'approved' ? 
                    '<span class="badge bg-success">Approved</span>' : 
                    '<span class="badge bg-warning text-dark">Pending</span>';
                
                let actionButtons = `
                    <button class="btn btn-sm btn-primary edit-condolence" data-id="${condolence.id}">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                `;
                
                if (currentUserRole === 'admin') {
                    if (condolence.status !== 'approved') {
                        actionButtons += `
                            <button class="btn btn-sm btn-success approve-condolence" data-id="${condolence.id}">
                                <i class="fas fa-check"></i> Approve
                            </button>
                        `;
                    }
                    actionButtons += `
                        <button class="btn btn-sm btn-danger delete-condolence" data-id="${condolence.id}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                }
                
                table.row.add([
                    condolence.memberId || '',
                    member ? member.name : 'Unknown',
                    'KES ' + parseFloat(condolence.amount || 0).toLocaleString(),
                    beneficiary ? beneficiary.name : 'Unknown',
                    condolence.date || '',
                    condolence.time || '',
                    statusBadge,
                    `<div class="action-buttons">${actionButtons}</div>`
                ]).draw(false);
            });
        }

        function populateHealthTable(data) {
            const table = $('#health-table').DataTable();
            table.clear().draw();
            
            if (data.length === 0) {
                table.row.add(['', '', '', '', '', '', '', 'No health contributions found']).draw();
                return;
            }
            
            data.forEach(health => {
                const member = membersData.find(m => m.id === health.memberId);
                const beneficiary = membersData.find(m => m.id === health.beneficiaryId);
                const statusBadge = health.status === 'approved' ? 
                    '<span class="badge bg-success">Approved</span>' : 
                    '<span class="badge bg-warning text-dark">Pending</span>';
                
                let actionButtons = `
                    <button class="btn btn-sm btn-primary edit-health" data-id="${health.id}">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                `;
                
                if (currentUserRole === 'admin') {
                    if (health.status !== 'approved') {
                        actionButtons += `
                            <button class="btn btn-sm btn-success approve-health" data-id="${health.id}">
                                <i class="fas fa-check"></i> Approve
                            </button>
                        `;
                    }
                    actionButtons += `
                        <button class="btn btn-sm btn-danger delete-health" data-id="${health.id}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                }
                
                table.row.add([
                    health.memberId || '',
                    member ? member.name : 'Unknown',
                    'KES ' + parseFloat(health.amount || 0).toLocaleString(),
                    beneficiary ? beneficiary.name : 'Unknown',
                    health.date || '',
                    health.time || '',
                    statusBadge,
                    `<div class="action-buttons">${actionButtons}</div>`
                ]).draw(false);
            });
        }

        function populateEducationTable(data) {
            const table = $('#education-table').DataTable();
            table.clear().draw();
            
            if (data.length === 0) {
                table.row.add(['', '', '', '', '', '', '', 'No education contributions found']).draw();
                return;
            }
            
            data.forEach(education => {
                const member = membersData.find(m => m.id === education.memberId);
                const beneficiary = membersData.find(m => m.id === education.beneficiaryId);
                const statusBadge = education.status === 'approved' ? 
                    '<span class="badge bg-success">Approved</span>' : 
                    '<span class="badge bg-warning text-dark">Pending</span>';
                
                let actionButtons = `
                    <button class="btn btn-sm btn-primary edit-education" data-id="${education.id}">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                `;
                
                if (currentUserRole === 'admin') {
                    if (education.status !== 'approved') {
                        actionButtons += `
                            <button class="btn btn-sm btn-success approve-education" data-id="${education.id}">
                                <i class="fas fa-check"></i> Approve
                            </button>
                        `;
                    }
                    actionButtons += `
                        <button class="btn btn-sm btn-danger delete-education" data-id="${education.id}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                }
                
                table.row.add([
                    education.memberId || '',
                    member ? member.name : 'Unknown',
                    'KES ' + parseFloat(education.amount || 0).toLocaleString(),
                    beneficiary ? beneficiary.name : 'Unknown',
                    education.date || '',
                    education.time || '',
                    statusBadge,
                    `<div class="action-buttons">${actionButtons}</div>`
                ]).draw(false);
            });
        }

        // Dashboard Functions
        function updateDashboardStats() {
            $('#total-members').text(membersData.length);
            
            const totalSavings = savingsData.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
            $('#total-savings').text('KES ' + totalSavings.toLocaleString());
            
            const totalCondolences = condolencesData.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
            $('#total-condolences').text('KES ' + totalCondolences.toLocaleString());
            
            const totalHealth = healthData.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
            $('#total-health').text('KES ' + totalHealth.toLocaleString());
            
            const totalEducation = educationData.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
            $('#total-education').text('KES ' + totalEducation.toLocaleString());
            
            updateBeneficiariesTable();
        }

        function updateBeneficiariesTable() {
            const allContributions = [...savingsData, ...condolencesData, ...healthData, ...educationData];
            const beneficiariesMap = new Map();
            
            allContributions.forEach(contribution => {
                if (!beneficiariesMap.has(contribution.beneficiaryId)) {
                    const beneficiary = membersData.find(m => m.id === contribution.beneficiaryId);
                    if (beneficiary) {
                        beneficiariesMap.set(contribution.beneficiaryId, {
                            name: beneficiary.name,
                            totalAmount: 0,
                            contributorCount: 0
                        });
                    }
                }
                
                const beneficiaryData = beneficiariesMap.get(contribution.beneficiaryId);
                if (beneficiaryData) {
                    beneficiaryData.totalAmount += parseFloat(contribution.amount || 0);
                    beneficiaryData.contributorCount++;
                }
            });
            
            const table = $('#beneficiaries-table').DataTable();
            table.clear().draw();
            
            if (beneficiariesMap.size === 0) {
                table.row.add(['', '', 'No beneficiaries found']).draw();
                return;
            }
            
            beneficiariesMap.forEach((value, key) => {
                table.row.add([
                    value.name || 'Unknown',
                    'KES ' + value.totalAmount.toLocaleString(),
                    value.contributorCount
                ]).draw(false);
            });
        }

        // Navigation Functions
        function setupNavigation() {
            $(document).on('click', '.nav-link, .mobile-menu-link', function(e) {
                e.preventDefault();
                const section = $(this).data('section');
                showSection(section);
            });
        }

        function showSection(section) {
            $('.content-section').hide();
            $(`#${section}-section`).show();
            
            $('.nav-link, .mobile-menu-link').removeClass('active');
            $(`.nav-link[data-section="${section}"], .mobile-menu-link[data-section="${section}"]`).addClass('active');
            
            if ($(window).width() <= 768) {
                window.scrollTo(0, 0);
            }
        }

        // Form Handling Functions
        function setupFormHandlers() {
            // Member form
            $('#saveMemberBtn').click(function() {
                const memberData = {
                    id: $('#memberId').val() || generateMemberId(),
                    name: $('#memberName').val(),
                    contact: $('#memberContact').val(),
                    subLocation: $('#memberSubLocation').val(),
                    clan: $('#memberClan').val()
                };
                
                if (!validateMemberForm(memberData)) return;
                
                showLoading('members-section');
                $.ajax({
                    url: scriptUrl,
                    method: 'POST',
                    dataType: 'json',
                    data: {
                        action: 'saveMember',
                        ...memberData
                    },
                    success: function() {
                        $('#addMemberModal').modal('hide');
                        showSuccess('Member saved successfully');
                        $('#members-table').DataTable().clear().destroy();
                        loadMembers();
                        resetMemberForm();
                        hideLoading('members-section');
                    },
                    error: function(error) {
                        showError(error.responseJSON ? error.responseJSON.message : 'Failed to save member');
                        hideLoading('members-section');
                    }
                });
            });
            
            // Savings form
            $('#saveSavingsBtn').click(function() {
                const savingsData = {
                    id: $('#savingsId').val(),
                    memberId: $('#savingsMember').val(),
                    amount: $('#savingsAmount').val(),
                    beneficiaryId: $('#savingsBeneficiary').val(),
                    date: $('#savingsDate').val(),
                    time: $('#savingsTime').val(),
                    status: 'pending'
                };
                
                if (!validateSavingsForm(savingsData)) return;
                
                showLoading('savings-section');
                $.ajax({
                    url: scriptUrl,
                    method: 'POST',
                    dataType: 'json',
                    data: {
                        action: 'saveSavings',
                        ...savingsData
                    },
                    success: function() {
                        $('#addSavingsModal').modal('hide');
                        showSuccess('Savings contribution saved successfully');
                        $('#savings-table').DataTable().clear().destroy();
                        loadSavings();
                        resetSavingsForm();
                        hideLoading('savings-section');
                    },
                    error: function(error) {
                        showError(error.responseJSON ? error.responseJSON.message : 'Failed to save savings');
                        hideLoading('savings-section');
                    }
                });
            });
            
            // Condolence form
            $('#saveCondolenceBtn').click(function() {
                const condolenceData = {
                    id: $('#condolenceId').val(),
                    memberId: $('#condolenceMember').val(),
                    amount: $('#condolenceAmount').val(),
                    beneficiaryId: $('#condolenceBeneficiary').val(),
                    date: $('#condolenceDate').val(),
                    time: $('#condolenceTime').val(),
                    status: 'pending'
                };
                
                if (!validateCondolenceForm(condolenceData)) return;
                
                showLoading('condolences-section');
                $.ajax({
                    url: scriptUrl,
                    method: 'POST',
                    dataType: 'json',
                    data: {
                        action: 'saveCondolence',
                        ...condolenceData
                    },
                    success: function() {
                        $('#addCondolenceModal').modal('hide');
                        showSuccess('Condolence contribution saved successfully');
                        $('#condolences-table').DataTable().clear().destroy();
                        loadCondolences();
                        resetCondolenceForm();
                        hideLoading('condolences-section');
                    },
                    error: function(error) {
                        showError(error.responseJSON ? error.responseJSON.message : 'Failed to save condolence');
                        hideLoading('condolences-section');
                    }
                });
            });
            
            // Health form
            $('#saveHealthBtn').click(function() {
                const healthData = {
                    id: $('#healthId').val(),
                    memberId: $('#healthMember').val(),
                    amount: $('#healthAmount').val(),
                    beneficiaryId: $('#healthBeneficiary').val(),
                    date: $('#healthDate').val(),
                    time: $('#healthTime').val(),
                    status: 'pending'
                };
                
                if (!validateHealthForm(healthData)) return;
                
                showLoading('health-section');
                $.ajax({
                    url: scriptUrl,
                    method: 'POST',
                    dataType: 'json',
                    data: {
                        action: 'saveHealth',
                        ...healthData
                    },
                    success: function() {
                        $('#addHealthModal').modal('hide');
                        showSuccess('Health contribution saved successfully');
                        $('#health-table').DataTable().clear().destroy();
                        loadHealth();
                        resetHealthForm();
                        hideLoading('health-section');
                    },
                    error: function(error) {
                        showError(error.responseJSON ? error.responseJSON.message : 'Failed to save health contribution');
                        hideLoading('health-section');
                    }
                });
            });
            
            // Education form
            $('#saveEducationBtn').click(function() {
                const educationData = {
                    id: $('#educationId').val(),
                    memberId: $('#educationMember').val(),
                    amount: $('#educationAmount').val(),
                    beneficiaryId: $('#educationBeneficiary').val(),
                    date: $('#educationDate').val(),
                    time: $('#educationTime').val(),
                    status: 'pending'
                };
                
                if (!validateEducationForm(educationData)) return;
                
                showLoading('education-section');
                $.ajax({
                    url: scriptUrl,
                    method: 'POST',
                    dataType: 'json',
                    data: {
                        action: 'saveEducation',
                        ...educationData
                    },
                    success: function() {
                        $('#addEducationModal').modal('hide');
                        showSuccess('Education contribution saved successfully');
                        $('#education-table').DataTable().clear().destroy();
                        loadEducation();
                        resetEducationForm();
                        hideLoading('education-section');
                    },
                    error: function(error) {
                        showError(error.responseJSON ? error.responseJSON.message : 'Failed to save education contribution');
                        hideLoading('education-section');
                    }
                });
            });
            
            // Confirmation modal
            $('#confirmActionBtn').click(function() {
                const action = $(this).data('action');
                const id = $(this).data('id');
                const type = $(this).data('type');
                
                if (action === 'delete') {
                    deleteRecord(id, type);
                } else if (action === 'approve') {
                    approveRecord(id, type);
                }
                
                $('#confirmationModal').modal('hide');
            });
            
            // Edit member
            $(document).on('click', '.edit-member', function() {
                const memberId = $(this).data('id');
                const member = membersData.find(m => m.id === memberId);
                if (member) {
                    $('#memberId').val(member.id);
                    $('#memberName').val(member.name);
                    $('#memberContact').val(member.contact);
                    $('#memberSubLocation').val(member.subLocation);
                    $('#memberClan').val(member.clan);
                    $('#addMemberModalLabel').text('Edit Member');
                    $('#addMemberModal').modal('show');
                }
            });
            
            // Delete member
            $(document).on('click', '.delete-member', function() {
                const memberId = $(this).data('id');
                showConfirmation('delete', memberId, 'member', 'Are you sure you want to delete this member?');
            });
            
            // Edit saving
            $(document).on('click', '.edit-saving', function() {
                const savingId = $(this).data('id');
                const saving = savingsData.find(s => s.id === savingId);
                if (saving) {
                    $('#savingsId').val(saving.id);
                    $('#savingsMember').val(saving.memberId);
                    $('#savingsAmount').val(saving.amount);
                    $('#savingsBeneficiary').val(saving.beneficiaryId);
                    $('#savingsDate').val(saving.date);
                    $('#savingsTime').val(saving.time);
                    $('#addSavingsModalLabel').text('Edit Savings Contribution');
                    $('#addSavingsModal').modal('show');
                }
            });
            
            // Approve saving
            $(document).on('click', '.approve-saving', function() {
                const savingId = $(this).data('id');
                showConfirmation('approve', savingId, 'saving', 'Are you sure you want to approve this savings contribution?');
            });
            
            // Delete saving
            $(document).on('click', '.delete-saving', function() {
                const savingId = $(this).data('id');
                showConfirmation('delete', savingId, 'saving', 'Are you sure you want to delete this savings contribution?');
            });
            
            // Edit condolence
            $(document).on('click', '.edit-condolence', function() {
                const condolenceId = $(this).data('id');
                const condolence = condolencesData.find(c => c.id === condolenceId);
                if (condolence) {
                    $('#condolenceId').val(condolence.id);
                    $('#condolenceMember').val(condolence.memberId);
                    $('#condolenceAmount').val(condolence.amount);
                    $('#condolenceBeneficiary').val(condolence.beneficiaryId);
                    $('#condolenceDate').val(condolence.date);
                    $('#condolenceTime').val(condolence.time);
                    $('#addCondolenceModalLabel').text('Edit Condolence Contribution');
                    $('#addCondolenceModal').modal('show');
                }
            });
            
            // Approve condolence
            $(document).on('click', '.approve-condolence', function() {
                const condolenceId = $(this).data('id');
                showConfirmation('approve', condolenceId, 'condolence', 'Are you sure you want to approve this condolence contribution?');
            });
            
            // Delete condolence
            $(document).on('click', '.delete-condolence', function() {
                const condolenceId = $(this).data('id');
                showConfirmation('delete', condolenceId, 'condolence', 'Are you sure you want to delete this condolence contribution?');
            });
            
            // Edit health
            $(document).on('click', '.edit-health', function() {
                const healthId = $(this).data('id');
                const health = healthData.find(h => h.id === healthId);
                if (health) {
                    $('#healthId').val(health.id);
                    $('#healthMember').val(health.memberId);
                    $('#healthAmount').val(health.amount);
                    $('#healthBeneficiary').val(health.beneficiaryId);
                    $('#healthDate').val(health.date);
                    $('#healthTime').val(health.time);
                    $('#addHealthModalLabel').text('Edit Health Contribution');
                    $('#addHealthModal').modal('show');
                }
            });
            
            // Approve health
            $(document).on('click', '.approve-health', function() {
                const healthId = $(this).data('id');
                showConfirmation('approve', healthId, 'health', 'Are you sure you want to approve this health contribution?');
            });
            
            // Delete health
            $(document).on('click', '.delete-health', function() {
                const healthId = $(this).data('id');
                showConfirmation('delete', healthId, 'health', 'Are you sure you want to delete this health contribution?');
            });
            
            // Edit education
            $(document).on('click', '.edit-education', function() {
                const educationId = $(this).data('id');
                const education = educationData.find(e => e.id === educationId);
                if (education) {
                    $('#educationId').val(education.id);
                    $('#educationMember').val(education.memberId);
                    $('#educationAmount').val(education.amount);
                    $('#educationBeneficiary').val(education.beneficiaryId);
                    $('#educationDate').val(education.date);
                    $('#educationTime').val(education.time);
                    $('#addEducationModalLabel').text('Edit Education Contribution');
                    $('#addEducationModal').modal('show');
                }
            });
            
            // Approve education
            $(document).on('click', '.approve-education', function() {
                const educationId = $(this).data('id');
                showConfirmation('approve', educationId, 'education', 'Are you sure you want to approve this education contribution?');
            });
            
            // Delete education
            $(document).on('click', '.delete-education', function() {
                const educationId = $(this).data('id');
                showConfirmation('delete', educationId, 'education', 'Are you sure you want to delete this education contribution?');
            });
        }

        // Validation Functions
        function validateMemberForm(data) {
            if (!data.name || !data.contact || !data.subLocation || !data.clan) {
                showError('Please fill all fields');
                return false;
            }
            return true;
        }

        function validateSavingsForm(data) {
            if (!data.memberId || !data.amount || !data.beneficiaryId || !data.date || !data.time) {
                showError('Please fill all fields');
                return false;
            }
            if (isNaN(data.amount)) {
                showError('Amount must be a number');
                return false;
            }
            return true;
        }

        function validateCondolenceForm(data) {
            if (!data.memberId || !data.amount || !data.beneficiaryId || !data.date || !data.time) {
                showError('Please fill all fields');
                return false;
            }
            if (isNaN(data.amount)) {
                showError('Amount must be a number');
                return false;
            }
            return true;
        }

        function validateHealthForm(data) {
            if (!data.memberId || !data.amount || !data.beneficiaryId || !data.date || !data.time) {
                showError('Please fill all fields');
                return false;
            }
            if (isNaN(data.amount)) {
                showError('Amount must be a number');
                return false;
            }
            return true;
        }

        function validateEducationForm(data) {
            if (!data.memberId || !data.amount || !data.beneficiaryId || !data.date || !data.time) {
                showError('Please fill all fields');
                return false;
            }
            if (isNaN(data.amount)) {
                showError('Amount must be a number');
                return false;
            }
            return true;
        }

        // CRUD Operations
        function deleteRecord(id, type) {
            showLoading(`${type}-section`);
            $.ajax({
                url: scriptUrl,
                method: 'POST',
                dataType: 'json',
                data: {
                    action: 'delete' + capitalizeFirstLetter(type),
                    id: id
                },
                success: function() {
                    showSuccess('Record deleted successfully');
                    $(`#${type}-table`).DataTable().clear().destroy();
                    loadAllData();
                    hideLoading(`${type}-section`);
                },
                error: function(error) {
                    showError(error.responseJSON ? error.responseJSON.message : 'Failed to delete record');
                    hideLoading(`${type}-section`);
                }
            });
        }

        function approveRecord(id, type) {
            showLoading(`${type}-section`);
            $.ajax({
                url: scriptUrl,
                method: 'POST',
                dataType: 'json',
                data: {
                    action: 'approve' + capitalizeFirstLetter(type),
                    id: id
                },
                success: function() {
                    showSuccess('Record approved successfully');
                    $(`#${type}-table`).DataTable().clear().destroy();
                    loadAllData();
                    hideLoading(`${type}-section`);
                },
                error: function(error) {
                    showError(error.responseJSON ? error.responseJSON.message : 'Failed to approve record');
                    hideLoading(`${type}-section`);
                }
            });
        }

        // UI Helpers
        function showConfirmation(action, id, type, message) {
            $('#confirmationMessage').text(message);
            $('#confirmActionBtn')
                .data('action', action)
                .data('id', id)
                .data('type', type);
            $('#confirmationModal').modal('show');
        }

        function showSuccess(message) {
            Swal.fire({
                title: 'Success',
                text: message,
                icon: 'success',
                confirmButtonText: 'OK'
            });
        }

        function showError(message) {
            Swal.fire({
                title: 'Error',
                text: typeof message === 'string' ? message : 'An error occurred',
                icon: 'error',
                confirmButtonText: 'OK'
            });
        }

        function showLoading(section) {
            $(`#${section}`).find('.loading-overlay').remove();
            $(`#${section}`).append(`
                <div class="loading-overlay" style="
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background-color: rgba(255,255,255,0.7);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                ">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `);
        }

        function hideLoading(section) {
            $(`#${section}`).find('.loading-overlay').remove();
        }

        function populateMemberDropdowns(members) {
            const memberDropdowns = [
                '#savingsMember', '#savingsBeneficiary', 
                '#condolenceMember', '#condolenceBeneficiary',
                '#healthMember', '#healthBeneficiary',
                '#educationMember', '#educationBeneficiary'
            ];
            
            memberDropdowns.forEach(dropdown => {
                const $dropdown = $(dropdown);
                $dropdown.empty();
                $dropdown.append('<option value="">Select Member</option>');
                
                members.forEach(member => {
                    $dropdown.append(`<option value="${member.id}">${member.name} (${member.id})</option>`);
                });
            });
        }

        function setCurrentDateTime() {
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().substring(0, 5);
            
            $('#savingsDate').val(dateStr);
            $('#savingsTime').val(timeStr);
            $('#condolenceDate').val(dateStr);
            $('#condolenceTime').val(timeStr);
            $('#healthDate').val(dateStr);
            $('#healthTime').val(timeStr);
            $('#educationDate').val(dateStr);
            $('#educationTime').val(timeStr);
        }

        // Form Reset Functions
        function resetMemberForm() {
            $('#memberForm')[0].reset();
            $('#memberId').val('');
            $('#addMemberModalLabel').text('Add New Member');
        }

        function resetSavingsForm() {
            $('#savingsForm')[0].reset();
            $('#savingsId').val('');
            setCurrentDateTime();
            $('#addSavingsModalLabel').text('Add Savings Contribution');
        }

        function resetCondolenceForm() {
            $('#condolenceForm')[0].reset();
            $('#condolenceId').val('');
            setCurrentDateTime();
            $('#addCondolenceModalLabel').text('Add Condolence Contribution');
        }

        function resetHealthForm() {
            $('#healthForm')[0].reset();
            $('#healthId').val('');
            setCurrentDateTime();
            $('#addHealthModalLabel').text('Add Health Contribution');
        }

        function resetEducationForm() {
            $('#educationForm')[0].reset();
            $('#educationId').val('');
            setCurrentDateTime();
            $('#addEducationModalLabel').text('Add Education Contribution');
        }

        function resetAllForms() {
            resetMemberForm();
            resetSavingsForm();
            resetCondolenceForm();
            resetHealthForm();
            resetEducationForm();
        }
        function updateDashboardStats() {
            // Update card values
            $('#total-members').text(membersData.length);
            
            const totalSavings = savingsData.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
            $('#total-savings').text('KES ' + totalSavings.toLocaleString());
            
            const totalCondolences = condolencesData.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
            $('#total-condolences').text('KES ' + totalCondolences.toLocaleString());
            
            const totalHealth = healthData.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
            $('#total-health').text('KES ' + totalHealth.toLocaleString());
            
            const totalEducation = educationData.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
            $('#total-education').text('KES ' + totalEducation.toLocaleString());
            
            // Update table footers
            $('#members-count').text(membersData.length);
            $('#savings-total').text('KES ' + totalSavings.toLocaleString());
            $('#condolences-total').text('KES ' + totalCondolences.toLocaleString());
            $('#health-total').text('KES ' + totalHealth.toLocaleString());
            $('#education-total').text('KES ' + totalEducation.toLocaleString());
            
            updateBeneficiariesTable();
        }

        function updateBeneficiariesTable() {
            const allContributions = [...savingsData, ...condolencesData, ...healthData, ...educationData];
            const beneficiariesMap = new Map();
            
            allContributions.forEach(contribution => {
                if (!beneficiariesMap.has(contribution.beneficiaryId)) {
                    const beneficiary = membersData.find(m => m.id === contribution.beneficiaryId);
                    if (beneficiary) {
                        beneficiariesMap.set(contribution.beneficiaryId, {
                            name: beneficiary.name,
                            totalAmount: 0,
                            contributorCount: 0
                        });
                    }
                }
                
                const beneficiaryData = beneficiariesMap.get(contribution.beneficiaryId);
                if (beneficiaryData) {
                    beneficiaryData.totalAmount += parseFloat(contribution.amount || 0);
                    beneficiaryData.contributorCount++;
                }
            });
            
            const table = $('#beneficiaries-table').DataTable();
            table.clear().draw();
            
            if (beneficiariesMap.size === 0) {
                table.row.add(['No beneficiaries found', '', '']).draw();
                return;
            }
            
            let grandTotal = 0;
            let totalContributors = 0;
            
            beneficiariesMap.forEach((value, key) => {
                table.row.add([
                    value.name || 'Unknown',
                    'KES ' + value.totalAmount.toLocaleString(),
                    value.contributorCount
                ]).draw(false);
                
                grandTotal += value.totalAmount;
                totalContributors += value.contributorCount;
            });
            
            // Update footer totals
            $('#beneficiaries-total').text('KES ' + grandTotal.toLocaleString());
            $('#beneficiaries-count').text(totalContributors);
        }

        // Enhanced print function
        function printTable(tableId) {
            const table = $('#' + tableId).DataTable();
            const title = $('#' + tableId).closest('.card').find('.card-header h5').text();
            
            // Create a print window
            const printWindow = window.open('', '_blank');
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Print: ${title}</title>
                    <style>
                        body { font-family: Arial; margin: 0.5in; }
                        h1 { text-align: center; font-size: 1.5em; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .table-total { font-weight: bold; background-color: #f8f9fa !important; }
                        .print-date { text-align: right; margin-bottom: 20px; }
                        @page { size: auto; margin: 5mm; }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none !important; }
                        }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <div class="print-date">Printed: ${new Date().toLocaleString()}</div>
                    ${$('#' + tableId).clone().removeClass('dataTable')[0].outerHTML}
                    <script>
                        window.onload = function() {
                            setTimeout(function() {
                                window.print();
                                window.close();
                            }, 100);
                        };
                    <` + `/script>
                </body>
                </html>
            `;
            
            printWindow.document.open();
            printWindow.document.write(printContent);
            printWindow.document.close();
        }

        // Initialize the application
        $(document).ready(function() {
            initializeApp();
        });
    </script>
</body>
</html>